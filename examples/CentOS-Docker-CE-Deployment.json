{
    "label":"Docker-CE-on-CentOS",
    "version":"0.1",
    "vmconfig" : {
        "datacentre" : "",
        "datastore":"",
        "network" : "",
        "host" : "",
        "guestCredentials" : {
            "guestUser" : "",
            "guestPass" :""
        }
    },
    "deployment": [
        {"name": "Docker Template",
         "note": "Build new template for CentOS",
         "task":{
            "inputTemplate": "centos7-tmpl",
            "outputName": "DockerTemplate",
            "outputType": "Template",
            "import":"",
            "commands": [
                {
                    "type":"execute",                    
                    "note":"Disable SELINUX (Older CentOS bug)",
                    "path":"/usr/sbin/setenforce",
                    "args":"0",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Upgrade all packages (except VMware Tools)",            
                    "path":"/bin/yum",
                    "args":"upgrade --exclude=open-vm-tools -y > /tmp/ce-yum-upgrade.log",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Re-Enable SELINUX",
                    "path":"/usr/sbin/setenforce",
                    "args":"1",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Remove any pre-existing Docker Installation",            
                    "path":"/bin/yum",
                    "args":"remove docker docker-common docker-selinux docker-engine",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Install Docker-CE Supporting tools",            
                    "path":"/bin/yum",
                    "args":"install -y yum-utils device-mapper-persistent-data lvm2 -y > /tmp/ce-docker-deps.log",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Add Docker CE Repository",            
                    "path":"/usr/bin/yum-config-manager",
                    "args":"--add-repo https://download.docker.com/linux/centos/docker-ce.repo",
                    "watch": true
                },
                {            
                    "type":"execute",                    
                    "note":"Update Yum Cache",            
                    "path":"/bin/yum",
                    "args":"-y makecache fast",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Installation of Docker-CE",            
                    "path":"/bin/yum",
                    "args":"-y install docker-ce > /tmp/ce-docker-install.log",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Enable Docker on Boot",            
                    "path":"/usr/bin/systemctl",
                    "args":"enable docker",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Start Docker to pre-configure system",            
                    "path":"/usr/bin/systemctl",
                    "args":"start docker",
                    "watch": true
                },                
                {
                    "type":"execute",                    
                    "note":"Set Storage Driver to devicemapper",            
                    "path":"/usr/bin/echo",
                    "args":"-en '{\n  \"storage-driver\": \"devicemapper\"\n}' > /etc/docker/daemon.json",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Restart Docker to pick up new storage Configuration",            
                    "path":"/usr/bin/systemctl",
                    "args":"restart docker",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Download UCP 2.2",            
                    "path":"/usr/bin/docker",
                    "args":"pull docker/ucp:2.2.0 >> /tmp/docker-pull.log",
                    "watch": true
                },
                {
                    "type":"execute",                    
                    "note":"Download DTR 2.2.7",            
                    "path":"/usr/bin/docker",
                    "args":"pull docker/dtr:2.2.7 >> /tmp/docker-pull.log",
                    "watch": true
                }
            ]
        }
            
        },{"name": "ucp",
            "note": "Build new template for CentOS",
            "task":{
               "inputTemplate": "DockerTemplate",
               "outputName": "ucp01",
               "outputType": "VM",
               "import":"",
               "commands": [
                   {
                       "type":"execute",                    
                       "note":"Initialise Docker Swarm",            
                       "path":"/usr/bin/docker",
                        "args":"swarm init",
                        "watch": true
                   },
                   {
                       "type":"execute",                    
                       "note":"Backing up swarm key for other nodes",            
                       "path":"/usr/bin/docker",
                       "args":"swarm join-token worker | grep SWMTKN > ~/swm.tkn",
                       "watch": true
                   },
                   {
                       "type":"download",
                       "path":"~/swm.tkn",
                       "delAfterDownload": true
                   }
                ]
            }
        }
    ]
}